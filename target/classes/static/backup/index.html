<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS - System zarządzania hurtownią pająków</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 960px; }
        .table th, .table td { vertical-align: middle; }
        .table thead th { background-color: #343a30; color: white; }
        .table-new-order { background-color: #d1e7dd; } /* Zielony */
        .table-cancelled-order { background-color: #f8d7da; } /* Czerwony */
        .table-shipped-order { background-color: #cfe2ff; } /* Niebieski */
        .modal-xl { --bs-modal-width: 90%; }
        .selectable-row:hover { background-color: #f2f2f2; cursor: pointer; }
        .selected-row { background-color: #e2f2ff; font-weight: bold; } /* Podświetlenie wybranego wiersza */

        /* Nowe, poprawione reguły CSS do drukowania */
        @media print {
            .navbar, .container, .modal-backdrop {
                display: none !important;
            }
            #orderDetailsModal {
                position: static !important;
                display: block !important;
                visibility: visible !important;
                top: auto !important;
                left: auto !important;
                margin: 0 !important;
            }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">WMS - Pająki</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#" onclick="showSection('customers-section')">Klienci</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('spiders-section')">Pająki</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('orders-section')">Zamówienia</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <section id="customers-section" class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Zarządzanie klientami</h2>
            <div class="d-flex">
                <button class="btn btn-danger me-2" onclick="clearAllCustomers()">Usuń wszystkich klientów</button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal" onclick="prepareCustomerForm('add')">Dodaj klienta</button>
            </div>
        </div>
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>Imię</th>
                <th>Nazwisko</th>
                <th>Adres e-mail</th>
                <th>Adres</th>
                <th>Akcje</th>
            </tr>
            </thead>
            <tbody id="customers-table">
            </tbody>
        </table>
    </section>

    <section id="spiders-section" class="mb-5 d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Zarządzanie pająkami</h2>
            <div class="d-flex">
                <button class="btn btn-danger me-2" onclick="clearAllSpiders()">Usuń wszystkie pająki</button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#spiderModal" onclick="prepareSpiderForm('add')">Dodaj pająka</button>
            </div>
        </div>
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>Rodzaj</th>
                <th>Nazwa gatunku</th>
                <th>Ilość</th>
                <th>Cena</th>
                <th>CITES</th>
                <th>Akcje</th>
            </tr>
            </thead>
            <tbody id="spiders-table">
            </tbody>
        </table>
    </section>

    <section id="orders-section" class="mb-5 d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Zarządzanie zamówieniami</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderModal" onclick="prepareOrderForm('add')">Dodaj zamówienie</button>
        </div>
        <div class="d-flex mb-3">
            <button class="btn btn-outline-dark me-2 active" onclick="filterOrders('all', event)">Wszystkie</button>
            <button class="btn btn-outline-success me-2" onclick="filterOrders('NEW', event)">Nowe</button>
            <button class="btn btn-outline-warning me-2" onclick="filterOrders('PENDING', event)">Oczekujące</button>
            <button class="btn btn-outline-info me-2" onclick="filterOrders('IN_PROGRESS', event)">W trakcie</button>
            <button class="btn btn-outline-primary me-2" onclick="filterOrders('SHIPPED', event)">Wysłane</button>
            <button class="btn btn-outline-secondary me-2" onclick="filterOrders('COMPLETED', event)">Zakończone</button>
            <button class="btn btn-outline-danger me-2" onclick="filterOrders('CANCELLED', event)">Anulowane</button>
        </div>
        <table class="table table-hover table-bordered">
            <thead>
            <tr>
                <th>Data</th>
                <th>Cena</th>
                <th>Status</th>
                <th>Klient</th>
                <th>Akcje</th>
            </tr>
            </thead>
            <tbody id="orders-table">
            </tbody>
        </table>
    </section>
</div>

<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="customer-form" onsubmit="event.preventDefault(); saveCustomer();">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalLabel">Klient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="customer-id">
                    <div class="mb-3">
                        <label for="customer-firstName" class="form-label">Imię</label>
                        <input type="text" class="form-control" id="customer-firstName" required>
                    </div>
                    <div class="mb-3">
                        <label for="customer-lastName" class="form-label">Nazwisko</label>
                        <input type="text" class="form-control" id="customer-lastName" required>
                    </div>
                    <div class="mb-3">
                        <label for="customer-telephone" class="form-label">Telefon</label>
                        <input type="tel" class="form-control" id="customer-telephone">
                    </div>
                    <div class="mb-3">
                        <label for="customer-email" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="customer-email">
                    </div>
                    <div class="mb-3">
                        <label for="customer-address" class="form-label">Adres</label>
                        <input type="text" class="form-control" id="customer-address">
                    </div>
                    <div class="mb-3">
                        <label for="customer-parcelLocker" class="form-label">Paczkomat</label>
                        <input type="text" class="form-control" id="customer-parcelLocker">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="spiderModal" tabindex="-1" aria-labelledby="spiderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="spider-form" onsubmit="event.preventDefault(); saveSpider();">
                <div class="modal-header">
                    <h5 class="modal-title" id="spiderModalLabel">Pająk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="spider-id">
                    <div class="mb-3">
                        <label for="spider-typeName" class="form-label">Typ</label>
                        <input type="text" class="form-control" id="spider-typeName" required>
                    </div>
                    <div class="mb-3">
                        <label for="spider-speciesName" class="form-label">Gatunek</label>
                        <input type="text" class="form-control" id="spider-speciesName" required>
                    </div>
                    <div class="mb-3">
                        <label for="spider-quantity" class="form-label">Ilość</label>
                        <input type="number" class="form-control" id="spider-quantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="spider-size" class="form-label">Rozmiar</label>
                        <input type="text" class="form-control" id="spider-size">
                    </div>
                    <div class="mb-3">
                        <label for="spider-price" class="form-label">Cena</label>
                        <input type="number" class="form-control" id="spider-price" step="0.01" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="spider-isCites">
                        <label class="form-check-label" for="spider-isCites">CITES</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form id="order-form" onsubmit="event.preventDefault(); saveOrder();">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderModalLabel">Zamówienie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="order-id">
                    <input type="hidden" id="order-customer-id">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="mt-4">Wybierz klienta</h4>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                    <tr>
                                        <th>Imię</th>
                                        <th>Nazwisko</th>
                                        <th>Akcje</th>
                                    </tr>
                                    </thead>
                                    <tbody id="customer-selection-table">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 class="mt-4">Szczegóły klienta</h4>
                            <div id="customer-details">
                                <p>Wybierz klienta z tabeli po lewej, aby zobaczyć szczegóły.</p>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h4>Pająki dostępne do zamówienia</h4>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                    <tr>
                                        <th>Rodzaj</th>
                                        <th>Gatunek</th>
                                        <th>Ilość dostępna</th>
                                        <th>Cena</th>
                                        <th>Akcje</th>
                                    </tr>
                                    </thead>
                                    <tbody id="spider-selection-table">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4>Pająki w zamówieniu</h4>
                            <table class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th>Rodzaj</th>
                                    <th>Gatunek</th>
                                    <th>Ilość</th>
                                    <th>Cena</th>
                                    <th>Suma</th>
                                    <th>Akcje</th>
                                </tr>
                                </thead>
                                <tbody id="ordered-spiders-table">
                                </tbody>
                            </table>
                            <div class="d-flex justify-content-end align-items-center mt-3">
                                <h5>Suma całkowita: <span id="order-total-price">0.00</span> PLN</h5>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col">
                            <h4>Dane zamówienia</h4>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="order-status" class="form-label">Status zamówienia</label>
                                    <select class="form-select" id="order-status">
                                        <option value="NEW">NOWE</option>
                                        <option value="PENDING">OCZEKUJĄCE</option>
                                        <option value="IN_PROGRESS">W TRAKCIE</option>
                                        <option value="SHIPPED">WYSŁANE</option>
                                        <option value="COMPLETED">ZAKOŃCZONE</option>
                                        <option value="CANCELLED">ANULOWANE</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="order-shipmentNumber" class="form-label">Numer przesyłki</label>
                                    <input type="text" class="form-control" id="order-shipmentNumber">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="order-courierCompany" class="form-label">Firma kurierska</label>
                                    <select class="form-select" id="order-courierCompany">
                                        <option value="DPD">DPD</option>
                                        <option value="INPOST">INPOST</option>
                                        <option value="POCZTEX">POCZTEX</option>
                                        <option value="UPS">UPS</option>
                                        <option value="GLS">GLS</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3 form-check d-flex align-items-center mt-4">
                                    <input type="checkbox" class="form-check-input" id="order-selfCollection">
                                    <label class="form-check-label ms-2" for="order-selfCollection">Odbiór osobisty</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                    <button type="submit" class="btn btn-primary">Zapisz zamówienie</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Szczegóły Zamówienia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetails-content"></div>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#orderModal" id="edit-button" >Edytuj</button>
                    <button class="btn btn-info me-2" onclick="printOrder()">Drukuj</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = 'http://localhost:8080/api';
    let customers = [];
    let currentSpiders = [];
    let orderedSpiders = [];
    let currentOrderId = null;
    let selectedCustomerId = null;
    let currentOrderPrice = 0;
    let allOrders = [];

    function showSection(sectionId) {
        document.querySelectorAll('section').forEach(section => {
            section.classList.add('d-none');
        });
        document.getElementById(sectionId).classList.remove('d-none');
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`a[onclick*="${sectionId}"]`).classList.add('active');
        if (sectionId === 'orders-section') {
            loadOrders();
        }
        if (sectionId === 'customers-section') {
            loadCustomers();
        }
        if (sectionId === 'spiders-section') {
            loadSpiders();
        }
    }

    // Customer functions
    async function loadCustomers() {
        try {
            const response = await fetch(`${API_URL}/customers`);
            if (!response.ok) throw new Error('Nie udało się załadować klientów.');
            const data = await response.json();
            customers = data.content;
            const tableBody = document.getElementById('customers-table');
            tableBody.innerHTML = '';
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.firstName}</td>
                    <td>${customer.lastName}</td>
                    <td>${customer.email}</td>
                    <td>${customer.address}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal" data-bs-target="#customerModal" onclick="prepareCustomerForm('edit', '${customer.id}')">Edytuj</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}')">Usuń</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Błąd podczas ładowania klientów:', error);
        }
    }

    async function saveCustomer() {
        const id = document.getElementById('customer-id').value;
        const customer = {
            firstName: document.getElementById('customer-firstName').value,
            lastName: document.getElementById('customer-lastName').value,
            telephone: document.getElementById('customer-telephone').value,
            email: document.getElementById('customer-email').value,
            address: document.getElementById('customer-address').value,
            parcelLocker: document.getElementById('customer-parcelLocker').value,
        };

        try {
            const url = id ? `${API_URL}/customers/${id}` : `${API_URL}/customers`;
            const method = id ? 'PUT' : 'POST';
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(customer)
            });
            if (!response.ok) throw new Error('Nie udało się zapisać klienta.');
            await loadCustomers();
            bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
        } catch (error) {
            console.error('Błąd podczas zapisywania klienta:', error);
            alert('Wystąpił błąd podczas zapisywania klienta. Sprawdź, czy wszystkie pola są poprawnie wypełnione.');
        }
    }

    function prepareCustomerForm(mode, id = null) {
        document.getElementById('customer-form').reset();
        document.getElementById('customer-id').value = '';
        if (mode === 'edit' && id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                document.getElementById('customer-id').value = customer.id;
                document.getElementById('customer-firstName').value = customer.firstName;
                document.getElementById('customer-lastName').value = customer.lastName;
                document.getElementById('customer-telephone').value = customer.telephone;
                document.getElementById('customer-email').value = customer.email;
                document.getElementById('customer-address').value = customer.address;
                document.getElementById('customer-parcelLocker').value = customer.parcelLocker;
            }
        }
    }

    async function deleteCustomer(id) {
        if (!confirm('Czy na pewno chcesz usunąć tego klienta?')) return;
        try {
            const response = await fetch(`${API_URL}/customers/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Nie udało się usunąć klienta.');
            await loadCustomers();
        } catch (error) {
            console.error('Błąd podczas usuwania klienta:', error);
            alert('Wystąpił błąd podczas usuwania klienta. Upewnij się, że nie ma on aktywnych zamówień.');
        }
    }

    // Spider functions
    async function loadSpiders() {
        try {
            const response = await fetch(`${API_URL}/spiders?size=100`);
            if (!response.ok) throw new Error('Nie udało się załadować pająków.');
            const data = await response.json();
            const spiders = data.content;
            const tableBody = document.getElementById('spiders-table');
            tableBody.innerHTML = '';
            spiders.forEach(spider => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${spider.typeName}</td>
                    <td>${spider.speciesName}</td>
                    <td>${spider.quantity}</td>
                    <td>${spider.price.toFixed(2)} PLN</td>
                    <td>${spider.cites ? 'Tak' : 'Nie'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal" data-bs-target="#spiderModal" onclick="prepareSpiderForm('edit', '${spider.id}')">Edytuj</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSpider('${spider.id}')">Usuń</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Błąd podczas ładowania pająków:', error);
        }
    }

    async function saveSpider() {
        const id = document.getElementById('spider-id').value;
        const spider = {
            typeName: document.getElementById('spider-typeName').value,
            speciesName: document.getElementById('spider-speciesName').value,
            quantity: parseInt(document.getElementById('spider-quantity').value),
            size: document.getElementById('spider-size').value,
            price: parseFloat(document.getElementById('spider-price').value),
            isCites: document.getElementById('spider-isCites').checked,
        };

        try {
            const url = id ? `${API_URL}/spiders/${id}` : `${API_URL}/spiders`;
            const method = id ? 'PUT' : 'POST';
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(spider)
            });
            if (!response.ok) throw new Error('Nie udało się zapisać pająka.');
            await loadSpiders();
            bootstrap.Modal.getInstance(document.getElementById('spiderModal')).hide();
        } catch (error) {
            console.error('Błąd podczas zapisywania pająka:', error);
            alert('Wystąpił błąd podczas zapisywania pająka. Sprawdź, czy wszystkie pola są poprawnie wypełnione.');
        }
    }

    function prepareSpiderForm(mode, id = null) {
        document.getElementById('spider-form').reset();
        document.getElementById('spider-id').value = '';
        if (mode === 'edit' && id) {
            const spider = currentSpiders.find(s => s.id === id);
            if (spider) {
                document.getElementById('spider-id').value = spider.id;
                document.getElementById('spider-typeName').value = spider.typeName;
                document.getElementById('spider-speciesName').value = spider.speciesName;
                document.getElementById('spider-quantity').value = spider.quantity;
                document.getElementById('spider-size').value = spider.size;
                document.getElementById('spider-price').value = spider.price;
                document.getElementById('spider-isCites').checked = spider.isCites;
            }
        }
    }

    async function deleteSpider(id) {
        if (!confirm('Czy na pewno chcesz usunąć tego pająka?')) return;
        try {
            const response = await fetch(`${API_URL}/spiders/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Nie udało się usunąć pająka.');
            await loadSpiders();
        } catch (error) {
            console.error('Błąd podczas usuwania pająka:', error);
            alert('Wystąpił błąd podczas usuwania pająka.');
        }
    }

    // Order functions
    async function loadOrders() {
        try {
            const response = await fetch(`${API_URL}/orders`);
            if (!response.ok) throw new Error('Nie udało się załadować zamówień.');
            const data = await response.json();
            allOrders = data.content;
            filterOrders('all');
        } catch (error) {
            console.error('Błąd podczas ładowania zamówień:', error);
        }
    }

    function renderOrdersTable(ordersToDisplay) {
        const tableBody = document.getElementById('orders-table');
        tableBody.innerHTML = '';
        ordersToDisplay.forEach(order => {
            const row = document.createElement('tr');
            let rowClass = '';
            if (order.status === 'NEW') rowClass = 'table-new-order';
            if (order.status === 'SHIPPED') rowClass = 'table-shipped-order';
            if (order.status === 'CANCELLED') rowClass = 'table-cancelled-order';
            row.className = rowClass;
            row.innerHTML = `
                <td>${order.date}</td>
                <td>${order.price.toFixed(2)} PLN</td>
                <td>${order.status}</td>
                <td>${order.customer ? order.customer.firstName + ' ' + order.customer.lastName : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-info me-2" onclick="showOrderDetails('${order.id}')">Szczegóły</button>
                    <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal" data-bs-target="#orderModal" onclick="prepareOrderForm('edit', '${order.id}')">Edytuj</button>
                    ${order.status === 'NEW' ? `<button class="btn btn-sm btn-danger me-2" onclick="cancelOrder('${order.id}')">Anuluj</button>` : ''}
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function filterOrders(status, event) {
        if (event) {
            document.querySelectorAll('.btn-outline-dark, .btn-outline-success, .btn-outline-warning, .btn-outline-info, .btn-outline-primary, .btn-outline-secondary, .btn-outline-danger').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        let ordersToDisplay = [];
        if (status === 'all') {
            ordersToDisplay = allOrders;
        } else {
            ordersToDisplay = allOrders.filter(order => order.status === status);
        }
        renderOrdersTable(ordersToDisplay);
    }

    async function cancelOrder(id) {
        if (!confirm('Czy na pewno chcesz anulować to zamówienie?')) return;

        try {
            const orderToCancel = allOrders.find(order => order.id === id);
            if (!orderToCancel) {
                throw new Error('Zamówienie nie znaleziono.');
            }

            const updatedOrder = {
                ...orderToCancel,
                status: 'CANCELLED'
            };

            const response = await fetch(`${API_URL}/orders/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedOrder)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Nie udało się anulować zamówienia.');
            }

            // Poprawka: Usunięcie automatycznego wywoływania showOrderDetails
            // const savedOrder = await response.json();
            bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
            await loadOrders();
            // showOrderDetails(savedOrder.id);
        } catch (error) {
            console.error('Błąd podczas anulowania zamówienia:', error);
            alert('Wystąpił błąd podczas anulowania zamówienia: ' + error.message);
        }
    }

    async function saveOrder() {
        if (!selectedCustomerId) {
            alert('Musisz wybrać klienta, aby utworzyć zamówienie.');
            return;
        }

        const orderDTO = {
            id: currentOrderId,
            customerId: selectedCustomerId,
            orderedSpiders: orderedSpiders.map(os => ({
                spiderId: os.spider.id,
                quantity: os.quantity
            })),
            status: document.getElementById('order-status').value,
            shipmentNumber: document.getElementById('order-shipmentNumber').value,
            courierCompany: document.getElementById('order-courierCompany').value,
            selfCollection: document.getElementById('order-selfCollection').checked,
        };

        try {
            const url = currentOrderId ? `${API_URL}/orders/${currentOrderId}` : `${API_URL}/orders`;
            const method = currentOrderId ? 'PUT' : 'POST';
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderDTO)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Nie udało się zapisać zamówienia.');
            }

            // Poprawka: Usunięcie automatycznego wywoływania showOrderDetails
            // const savedOrder = await response.json();
            bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
            await loadOrders();
            // showOrderDetails(savedOrder.id);
        } catch (error) {
            console.error('Błąd podczas zapisywania zamówienia:', error);
            alert('Wystąpił błąd podczas zapisywania zamówienia: ' + error.message);
        }
    }

    function prepareOrderForm(mode, id = null) {
        document.getElementById('order-form').reset();
        currentOrderId = null;
        selectedCustomerId = null;
        orderedSpiders = [];
        renderOrderedSpidersTable();
        document.querySelectorAll('#customer-selection-table .selected-row').forEach(row => row.classList.remove('selected-row'));
        document.getElementById('customer-details').innerHTML = '<p>Wybierz klienta z tabeli po lewej, aby zobaczyć szczegóły.</p>';

        if (mode === 'add') {
            document.getElementById('order-status').value = 'NEW';
            document.getElementById('order-shipmentNumber').value = '';
            document.getElementById('order-courierCompany').value = 'DPD';
            document.getElementById('order-selfCollection').checked = false;
            loadCustomersForOrder();
            loadSpidersForOrder();
        } else if (mode === 'edit' && id) {
            currentOrderId = id;
            loadCustomersForOrder();
            loadSpidersForOrder();
            loadOrderDataForEdit(id);
        }
    }

    async function loadCustomersForOrder() {
        try {
            const response = await fetch(`${API_URL}/customers?size=100`);
            const data = await response.json();
            customers = data.content;
            const tableBody = document.getElementById('customer-selection-table');
            tableBody.innerHTML = '';
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.classList.add('selectable-row');
                row.innerHTML = `
                    <td>${customer.firstName}</td>
                    <td>${customer.lastName}</td>
                    <td><button class="btn btn-sm btn-success" onclick="selectCustomer(event, '${customer.id}')">Wybierz</button></td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Błąd podczas ładowania klientów do zamówienia:', error);
        }
    }

    function selectCustomer(event, customerId) {
        if (event) event.preventDefault();
        document.querySelectorAll('#customer-selection-table .selectable-row').forEach(row => row.classList.remove('selected-row'));
        const selectedRow = document.querySelector(`#customer-selection-table button[onclick*="${customerId}"]`).closest('tr');
        if (selectedRow) {
            selectedRow.classList.add('selected-row');
        }
        selectedCustomerId = customerId;
        const customer = customers.find(c => c.id === customerId);
        if (customer) {
            document.getElementById('customer-details').innerHTML = `
                <p><strong>Imię:</strong> ${customer.firstName}</p>
                <p><strong>Nazwisko:</strong> ${customer.lastName}</p>
                <p><strong>E-mail:</strong> ${customer.email}</p>
                <p><strong>Telefon:</strong> ${customer.telephone}</p>
                <p><strong>Adres:</strong> ${customer.address}</p>
                <p><strong>Paczkomat:</strong> ${customer.parcelLocker}</p>
            `;
        }
    }

    async function loadSpidersForOrder() {
        try {
            const response = await fetch(`${API_URL}/spiders?size=100`);
            if (!response.ok) throw new Error('Nie udało się załadować pająków.');
            const data = await response.json();
            currentSpiders = data.content;
            const spidersTable = document.getElementById('spider-selection-table');
            spidersTable.innerHTML = '';
            currentSpiders.forEach(spider => {
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${spider.typeName}</td>
                        <td>${spider.speciesName}</td>
                        <td>${spider.quantity}</td>
                        <td>${spider.price.toFixed(2)} PLN</td>
                        <td>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" value="1" style="width: 60px;">
                                <button class="btn btn-sm btn-primary" type="button" onclick="addSpiderToOrder('${spider.id}')">Dodaj</button>
                            </div>
                        </td>
                    `;
                spidersTable.appendChild(row);
            });
        } catch (error) {
            console.error('Błąd podczas ładowania pająków:', error);
        }
    }

    function addSpiderToOrder(spiderId) {
        const selectedRow = document.querySelector(`#spider-selection-table button[onclick*="${spiderId}"]`).closest('tr');
        const quantityInput = selectedRow.querySelector('input[type="number"]');
        const quantity = parseInt(quantityInput.value);

        const spider = currentSpiders.find(s => s.id === spiderId);

        if (!spider || quantity <= 0 || spider.quantity < quantity) {
            alert('Nie można dodać tylu pająków. Sprawdź ilość na stanie i upewnij się, że podajesz poprawną wartość.');
            return;
        }

        const existingOrderedSpider = orderedSpiders.find(os => os.spider.id === spiderId);
        if (existingOrderedSpider) {
            existingOrderedSpider.quantity += quantity;
        } else {
            const orderedSpider = {
                spiderId: spiderId,
                quantity: quantity,
                spider: spider
            };
            orderedSpiders.push(orderedSpider);
        }

        // update available quantity
        spider.quantity -= quantity;
        selectedRow.querySelector('td:nth-child(3)').textContent = spider.quantity;
        quantityInput.value = 1;

        renderOrderedSpidersTable();
    }

    function removeSpiderFromOrder(spiderId) {
        const orderedSpiderIndex = orderedSpiders.findIndex(os => os.spider.id === spiderId);
        if (orderedSpiderIndex > -1) {
            const removedSpider = orderedSpiders[orderedSpiderIndex];
            orderedSpiders.splice(orderedSpiderIndex, 1);

            const originalSpider = currentSpiders.find(s => s.id === spiderId);
            if (originalSpider) {
                originalSpider.quantity += removedSpider.quantity;
                const spiderRow = document.querySelector(`#spider-selection-table button[onclick*="${spiderId}"]`).closest('tr');
                if (spiderRow) {
                    spiderRow.querySelector('td:nth-child(3)').textContent = originalSpider.quantity;
                }
            }
            renderOrderedSpidersTable();
        }
    }

    function renderOrderedSpidersTable() {
        const tableBody = document.getElementById('ordered-spiders-table');
        tableBody.innerHTML = '';
        currentOrderPrice = 0;
        orderedSpiders.forEach(os => {
            const row = document.createElement('tr');
            const totalItemPrice = os.quantity * os.spider.price;
            currentOrderPrice += totalItemPrice;
            row.innerHTML = `
                <td>${os.spider.typeName}</td>
                <td>${os.spider.speciesName}</td>
                <td>${os.quantity}</td>
                <td>${os.spider.price.toFixed(2)} PLN</td>
                <td>${totalItemPrice.toFixed(2)} PLN</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeSpiderFromOrder('${os.spider.id}')">Usuń</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        document.getElementById('order-total-price').textContent = currentOrderPrice.toFixed(2);
    }

    async function loadOrderDataForEdit(orderId) {
        try {
            const response = await fetch(`${API_URL}/orders/${orderId}`);
            if (!response.ok) throw new Error('Nie udało się załadować danych zamówienia.');
            const order = await response.json();

            // Set order details
            document.getElementById('order-status').value = order.status;
            document.getElementById('order-shipmentNumber').value = order.shipmentNumber;
            document.getElementById('order-courierCompany').value = order.courierCompany;
            document.getElementById('order-selfCollection').checked = order.selfCollection;

            // Select customer
            selectedCustomerId = order.customer.id;
            selectCustomer(null, selectedCustomerId);

            // Load ordered spiders and update available quantities
            orderedSpiders = order.orderedSpiders.map(os => {
                const spider = currentSpiders.find(s => s.id === os.spiderId);
                if (spider) {
                    const availableSpider = { ...spider };
                    availableSpider.quantity -= os.quantity;
                    const spiderRow = document.querySelector(`#spider-selection-table button[onclick*="${spider.id}"]`).closest('tr');
                    if (spiderRow) {
                        spiderRow.querySelector('td:nth-child(3)').textContent = availableSpider.quantity;
                    }
                }
                return {
                    spiderId: os.spiderId,
                    quantity: os.quantity,
                    spider: spider
                };
            });

            renderOrderedSpidersTable();

        } catch (error) {
            console.error('Błąd podczas ładowania danych zamówienia do edycji:', error);
            alert('Wystąpił błąd podczas ładowania danych zamówienia.');
        }
    }

    async function deleteOrder(id) {
        if (!confirm('Czy na pewno chcesz usunąć to zamówienie?')) return;
        try {
            const response = await fetch(`${API_URL}/orders/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Nie udało się usunąć zamówienia.');
            await loadOrders();
        } catch (error) {
            console.error('Błąd podczas usuwania zamówienia:', error);
            alert('Wystąpił błąd podczas usuwania zamówienia.');
        }
    }

    async function showOrderDetails(id) {
        try {
            const response = await fetch(`${API_URL}/orders/${id}`);
            if (!response.ok) throw new Error('Nie udało się załadować szczegółów zamówienia.');
            const order = await response.json();

            // Ustawienie onclick dla przycisku edycji
            document.getElementById('edit-button').onclick = function() {
                prepareOrderForm('edit', order.id);
            };
            const selfCollectionStatus = order.selfCollection ? 'Tak' : 'Nie';

            let detailsHtml = `
                <h5>Numer zamówienia: ${order.id}</h5>
                <p><strong>Data:</strong> ${order.date}</p>
                <p><strong>Status:</strong> ${order.status}</p>
                <p><strong>Całkowita cena:</strong> ${order.price.toFixed(2)} PLN</p>
                <hr>
                <h6>Dane Klienta:</h6>
                <p><strong>Imię i nazwisko:</strong> ${order.customer.firstName} ${order.customer.lastName}</p>
                <p><strong>E-mail:</strong> ${order.customer.email}</p>
                <p><strong>Adres:</strong> ${order.customer.address}</p>
                <p><strong>Paczkomat:</strong> ${order.customer.parcelLocker ? order.customer.parcelLocker : 'N/A'}</p>
                <hr>
                <h6>Dane przesyłki:</h6>
                <p><strong>Firma kurierska:</strong> ${order.courierCompany}</p>
                <p><strong>Numer przesyłki:</strong> ${order.shipmentNumber}</p>
                <p><strong>Odbiór osobisty:</strong> ${selfCollectionStatus}</p>
                <hr>
                <h6>Produkty w zamówieniu:</h6>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Rodzaj</th>
                            <th>Gatunek</th>
                            <th>Ilość</th>
                            <th>Cena jednostkowa</th>
                            <th>Suma</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            order.orderedSpiders.forEach(os => {
                detailsHtml += `
                    <tr>
                        <td>${os.spider.typeName}</td>
                        <td>${os.spider.speciesName}</td>
                        <td>${os.quantity}</td>
                        <td>${os.spider.price.toFixed(2)} PLN</td>
                        <td>${(os.quantity * os.spider.price).toFixed(2)} PLN</td>
                    </tr>
                `;
            });

            detailsHtml += `
                    </tbody>
                </table>
                <div class="d-flex justify-content-end mt-3">
                    <h5>Całkowita cena produktów: <span id="details-order-total-price">${order.price.toFixed(2)}</span> PLN</h5>
                </div>
            `;

            document.getElementById('orderDetails-content').innerHTML = detailsHtml;
            const myModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            myModal.show();

        } catch (error) {
            console.error('Błąd podczas wyświetlania szczegółów zamówienia:', error);
        }
    }

    function printOrder() {
        window.print();
    }

    async function clearAllCustomers() {
        if (!confirm('Czy na pewno chcesz USUNĄĆ WSZYSTKICH KLIENTÓW?')) return;
        try {
            const response = await fetch(`${API_URL}/customers?size=100`);
            const customers = (await response.json()).content;

            for (const customer of customers) {
                await fetch(`${API_URL}/customers/${customer.id}`, { method: 'DELETE' });
            }

            alert('Wszyscy klienci zostali pomyślnie usunięci!');
            loadCustomers();
        } catch (error) {
            console.error('Błąd podczas usuwania klientów:', error);
            alert('Wystąpił błąd podczas usuwania klientów. Upewnij się, że nie mają oni aktywnych zamówień.');
        }
    }

    async function clearAllSpiders() {
        if (!confirm('Czy na pewno chcesz USUNĄĆ WSZYSTKIE PAJĄKI?')) return;
        try {
            const response = await fetch(`${API_URL}/spiders?size=100`);
            const spiders = (await response.json()).content;

            for (const spider of spiders) {
                await fetch(`${API_URL}/spiders/${spider.id}`, { method: 'DELETE' });
            }

            alert('Wszystkie pająki zostały pomyślnie usunięte!');
            loadSpiders();
        } catch (error) {
            console.error('Błąd podczas usuwania pająków:', error);
            alert('Wystąpił błąd podczas usuwania pająków.');
        }
    }

    // Initial load
    window.onload = function() {
        showSection('customers-section');
    };
</script>
</body>
</html>