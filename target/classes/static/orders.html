<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>📦 Zamówienia</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
<div class="max-w-7xl mx-auto p-6 space-y-8">
    <h1 class="text-3xl font-bold text-center">📦 Tworzenie zamówienia</h1>

    <!-- Tabela klientów -->
    <div>
        <h2 class="text-xl font-semibold mb-2">🧑‍💼 Wybierz klienta</h2>
        <table class="w-full table-auto border border-gray-300 bg-white shadow-sm rounded-lg">
            <thead class="bg-gray-200">
            <tr><th>Imię</th><th>Nazwisko</th><th>Email</th><th>Akcja</th></tr>
            </thead>
            <tbody id="customerTableBody"></tbody>
        </table>
        <div class="flex justify-end mt-2">
            <button onclick="loadCustomers(currentCustomerPage - 1)" class="px-3 py-1 bg-gray-300 rounded mr-2">⬅️</button>
            <button onclick="loadCustomers(currentCustomerPage + 1)" class="px-3 py-1 bg-gray-300 rounded">➡️</button>
        </div>
    </div>

    <!-- Tabela pająków -->
    <div>
        <h2 class="text-xl font-semibold mb-2">🕷️ Wybierz pająki</h2>
        <table class="w-full table-auto border border-gray-300 bg-white shadow-sm rounded-lg">
            <thead class="bg-gray-200">
            <tr><th>Gatunek</th><th>Typ</th><th>Ilość</th><th>Cena</th><th>Akcja</th></tr>
            </thead>
            <tbody id="spiderTableBody"></tbody>
        </table>
        <div class="flex justify-end mt-2">
            <button onclick="loadSpiders(currentSpiderPage - 1)" class="px-3 py-1 bg-gray-300 rounded mr-2">⬅️</button>
            <button onclick="loadSpiders(currentSpiderPage + 1)" class="px-3 py-1 bg-gray-300 rounded">➡️</button>
        </div>
    </div>

    <!-- Formularz zamówienia -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">📋 Podsumowanie zamówienia</h2>
        <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="date" name="date" class="border p-2 rounded" required>
            <input type="number" name="price" id="priceInput" class="border p-2 rounded" placeholder="Cena" required>
            <select name="status" class="border p-2 rounded" required>
                <option value="NEW">Nowe</option>
                <option value="PENDING">Oczekujące</option>
                <option value="IN_PROGRESS">W realizacji</option>
                <option value="COMPLETED">Zrealizowane</option>
                <option value="CANCELLED">Anulowane</option>
            </select>
            <div class="md:col-span-2">
                <p><strong>👤 Klient:</strong> <span id="selectedCustomer">—</span></p>
                <p><strong>🕷️ Pająki:</strong></p>
                <ul id="selectedSpidersList" class="list-disc pl-6 text-sm"></ul>
            </div>
            <div class="md:col-span-2 flex gap-2 mt-2">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">💾 Zapisz</button>
            </div>
        </form>
    </div>

    <!-- Tabela zamówień -->
    <div>
        <h2 class="text-xl font-semibold mb-2">📦 Zamówienia</h2>
        <table class="w-full table-auto border border-gray-300 bg-white shadow-sm rounded-lg">
            <thead class="bg-gray-200">
            <tr><th>Data</th><th>Cena</th><th>Status</th><th>Klient</th><th>Pająki</th><th>Akcja</th></tr>
            </thead>
            <tbody id="orderTableBody"></tbody>
        </table>
        <div class="flex justify-end mt-2">
            <button onclick="loadOrders(currentOrderPage - 1)" class="px-3 py-1 bg-gray-300 rounded mr-2">⬅️</button>
            <button onclick="loadOrders(currentOrderPage + 1)" class="px-3 py-1 bg-gray-300 rounded">➡️</button>
        </div>
    </div>

    <!-- Panel szczegółów -->
    <div id="orderDetailsPanel" class="bg-white p-6 rounded-lg shadow-md hidden">
        <h2 class="text-xl font-semibold mb-4">🔍 Szczegóły zamówienia</h2>
        <p><strong>Data:</strong> <span id="detailDate"></span></p>
        <p><strong>Cena:</strong> <span id="detailPrice"></span> zł</p>
        <p><strong>Status:</strong>
            <select id="detailStatus" class="border p-2 rounded">
                <option value="NEW">Nowe</option>
                <option value="PENDING">Oczekujące</option>
                <option value="IN_PROGRESS">W realizacji</option>
                <option value="COMPLETED">Zrealizowane</option>
                <option value="CANCELLED">Anulowane</option>
            </select>
            <button onclick="updateOrderStatus()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 ml-2">💾 Zmień</button>
        </p>
        <p><strong>Klient:</strong> <span id="detailCustomer"></span></p>
        <p><strong>Pająki:</strong></p>
        <ul id="detailSpiders" class="list-disc pl-6 text-sm"></ul>
        <button onclick="closeOrderDetails()" class="bg-gray-400 text-white px-3 py-1 rounded hover:bg-gray-500 mt-4">❌ Zamknij</button>
    </div>
</div>

<script>
    const API_CUSTOMERS = "http://localhost:8080/api/customers";
    const API_SPIDERS = "http://localhost:8080/api/spiders";
    const API_ORDERS = "http://localhost:8080/api/orders";

    let currentCustomerPage = 0;
    let currentSpiderPage = 0;
    let currentOrderPage = 0;
    let selectedCustomerId = null;
    let selectedCustomerName = "—";
    let selectedSpiders = [];
    let currentOrderDetails = null;

    function loadCustomers(page = 0) {
        if (page < 0) return;
        fetch(`${API_CUSTOMERS}?page=${page}&size=5`)
            .then(res => res.json())
            .then(data => {
                currentCustomerPage = page;
                const tbody = document.getElementById("customerTableBody");
                tbody.innerHTML = "";
                data.content.forEach(c => {
                    const tr = document.createElement("tr");
                    tr.className = "border-t";
                    tr.innerHTML = `
            <td class="p-2">${c.firstName}</td>
            <td class="p-2">${c.lastName}</td>
            <td class="p-2">${c.email}</td>
            <td class="p-2">
              <button onclick="selectCustomer('${c.id}', '${c.firstName} ${c.lastName}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">➕ Dodaj</button>
            </td>
          `;
                    tbody.appendChild(tr);
                });
            });
    }

    function loadSpiders(page = 0) {
        if (page < 0) return;
        fetch(`${API_SPIDERS}?page=${page}&size=5`)
            .then(res => res.json())
            .then(data => {
                currentSpiderPage = page;
                const tbody = document.getElementById("spiderTableBody");
                tbody.innerHTML = "";
                data.content.forEach(s => {
                    const tr = document.createElement("tr");
                    tr.className = "border-t";
                    tr.innerHTML = `
            <td class="p-2">${s.speciesName}</td>
            <td class="p-2">${s.typeName}</td>
            <td class="p-2">${s.quantity}</td>
            <td class="p-2">${s.price} zł</td>
            <td class="p-2">
              <button onclick="addSpider('${s.id}', '${s.speciesName}', ${s.price})" class="bg-purple-500 text-white px-2 py-1 rounded hover:bg-purple-600">➕ Dodaj</button>
            </td>
          `;
                    tbody.appendChild(tr);
                });
            });
    }

    function selectCustomer(id, name) {
        selectedCustomerId = id;
        selectedCustomerName = name;
        document.getElementById("selectedCustomer").textContent = name;
    }

    function addSpider(id, name, price) {
        if (!selectedSpiders.some(s => s.id === id)) {
            selectedSpiders.push({ id, name, price });
            updateSpiderList();
        }
    }

    function removeSpider(id) {
        selectedSpiders = selectedSpiders.filter(s => s.id !== id);
        updateSpiderList();
    }

    function updateSpiderList() {
        const ul = document.getElementById("selectedSpidersList");
        ul.innerHTML = "";
        selectedSpiders.forEach(s => {
            const li = document.createElement("li");
            li.innerHTML = `${s.name} (${s.price} zł) <button onclick="removeSpider('${s.id}')" class="text-red-500 ml-2">❌</button>`;
            ul.appendChild(li);
        });
        const total = selectedSpiders.reduce((sum, s) => sum + (s.price > 0 ? s.price : 0), 0);
        document.getElementById("priceInput").value = total.toFixed(2);
    }

    document.getElementById("orderForm").addEventListener("submit", e => {
        e.preventDefault();
        const form = e.target;

        if (!selectedCustomerId || selectedSpiders.length === 0) {
            alert("Wybierz klienta i co najmniej jednego pająka.");
            return;
        }

        const order = {
            date: form.date.value,
            price: parseFloat(form.price.value),
            status: form.status.value,
            customer: { id: selectedCustomerId },
            orderedSpiders: selectedSpiders.map(s => ({ id: s.id }))
        };

        fetch(API_ORDERS, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(order)
        })
            .then(response => {
                if (!response.ok) throw new Error("Błąd podczas zapisu zamówienia.");
                return response.json();
            })
            .then(() => {
                form.reset();
                selectedCustomerId = null;
                selectedCustomerName = "—";
                selectedSpiders = [];
                document.getElementById("selectedCustomer").textContent = "—";
                document.getElementById("selectedSpidersList").innerHTML = "";
                document.getElementById("priceInput").value = "";
                loadOrders();
                alert("✅ Zamówienie zostało zapisane!");
            })
            .catch(error => alert("❌ " + error.message));
    });

    function loadOrders(page = 0) {
        if (page < 0) return;
        fetch(`${API_ORDERS}?page=${page}&size=5`)
            .then(res => res.json())
            .then(data => {
                currentOrderPage = page;
                const tbody = document.getElementById("orderTableBody");
                tbody.innerHTML = "";
                data.content.forEach(order => {
                    const spiders = order.orderedSpiders?.map(s => s.speciesName).join(", ") || "—";
                    const customer = order.customer ? `${order.customer.firstName} ${order.customer.lastName}` : "—";
                    const tr = document.createElement("tr");
                    tr.className = "border-t";
                    tr.innerHTML = `
            <td class="p-2">${order.date}</td>
            <td class="p-2">${order.price.toFixed(2)} zł</td>
            <td class="p-2">${order.status}</td>
            <td class="p-2">${customer}</td>
            <td class="p-2">${spiders}</td>
            <td class="p-2">
              <button onclick="viewOrderDetails('${order.order.id}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">🔍 Szczegóły</button>
            </td>
          `;
                    tbody.appendChild(tr);
                });
            });
    }

    function viewOrderDetails(orderId) {
        fetch(`${API_ORDERS}/${orderId}`)
            .then(res => {
                if (!res.ok) throw new Error("Nie znaleziono zamówienia");
                return res.json();
            })
            .then(order => {
                currentOrderDetails = order;
                document.getElementById("detailDate").textContent = order.date;
                document.getElementById("detailPrice").textContent = order.price.toFixed(2);
                document.getElementById("detailStatus").value = order.status;
                document.getElementById("detailCustomer").textContent = `${order.customer.firstName} ${order.customer.lastName}`;
                const ul = document.getElementById("detailSpiders");
                ul.innerHTML = "";
                order.orderedSpiders.forEach(spider => {
                    const li = document.createElement("li");
                    li.textContent = `${spider.speciesName} (${spider.price} zł)`;
                    ul.appendChild(li);
                });
                document.getElementById("orderDetailsPanel").classList.remove("hidden");
            })
            .catch(err => alert("❌ Błąd: " + err.message));
    }

    function updateOrderStatus() {
        const newStatus = document.getElementById("detailStatus").value;
        fetch(`${API_ORDERS}/${currentOrderDetails.orderId}/status/${newStatus}`, {
            method: "PUT"
        })
            .then(() => {
                alert("✅ Status zamówienia został zaktualizowany!");
                loadOrders();
                closeOrderDetails();
            });
    }

    function closeOrderDetails() {
        document.getElementById("orderDetailsPanel").classList.add("hidden");
    }

    // Inicjalizacja
    loadCustomers();
    loadSpiders();
    loadOrders();
</script>

</body>
</html>
