<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS - System zarządzania hurtownią pająków</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 960px; }
        .table th, .table td { vertical-align: middle; }
        .table thead th { background-color: #343a30; color: white; }
        .table-new-order { background-color: #d1e7dd; }
        .table-cancelled-order { background-color: #f8d7da; }
        .modal-xl { --bs-modal-width: 90%; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">WMS</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="#" data-section="customers">Klienci</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-section="orders">Zamówienia</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-section="spiders">Pająki</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div id="content">
        <div id="welcome-section" class="text-center">
            <h1>Witaj w systemie WMS</h1>
            <p class="lead">Zarządzaj klientami, zamówieniami i pająkami.</p>
            <p>
                <button class="btn btn-primary btn-lg m-2" onclick="showSection('customers')">Przejdź do klientów</button>
                <button class="btn btn-secondary btn-lg m-2" onclick="showSection('orders')">Przejdź do zamówień</button>
                <button class="btn btn-success btn-lg m-2" onclick="showSection('spiders')">Przejdź do pająków</button>
            </p>
        </div>
    </div>
</div>

<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Dodaj/Edytuj klienta</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="customerForm"><input type="hidden" id="customerId">
                    <div class="mb-3"><label for="firstName" class="form-label">Imię</label><input type="text" class="form-control" id="firstName" required></div>
                    <div class="mb-3"><label for="lastName" class="form-label">Nazwisko</label><input type="text" class="form-control" id="lastName" required></div>
                    <div class="mb-3"><label for="telephone" class="form-label">Telefon</label><input type="text" class="form-control" id="telephone"></div>
                    <div class="mb-3"><label for="email" class="form-label">Email</label><input type="email" class="form-control" id="email"></div>
                    <div class="mb-3"><label for="address" class="form-label">Adres</label><input type="text" class="form-control" id="address"></div>
                    <div class="mb-3"><label for="parcelLocker" class="form-label">Paczkomat</label><input type="text" class="form-control" id="parcelLocker"></div>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="spiderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Dodaj/Edytuj pająka</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="spiderForm"><input type="hidden" id="spiderId">
                    <div class="mb-3"><label for="typeName" class="form-label">Typ</label><input type="text" class="form-control" id="typeName" required></div>
                    <div class="mb-3"><label for="speciesName" class="form-label">Gatunek</label><input type="text" class="form-control" id="speciesName" required></div>
                    <div class="mb-3"><label for="quantity" class="form-label">Ilość</label><input type="number" class="form-control" id="quantity" required></div>
                    <div class="mb-3"><label for="size" class="form-label">Rozmiar</label><input type="text" class="form-control" id="size" required></div>
                    <div class="mb-3"><label for="price" class="form-label">Cena</label><input type="number" step="0.01" class="form-control" id="price" required></div>
                    <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="isCites"><label class="form-check-label" for="isCites">CITES</label></div>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Zmień status zamówienia</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="statusForm"><input type="hidden" id="orderIdToUpdate">
                    <div class="mb-3"><label for="orderStatusSelect" class="form-label">Nowy status</label><select class="form-select" id="orderStatusSelect" required></select></div>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Stwórz nowe zamówienie</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Wybierz klienta</h4>
                        <table class="table table-sm table-hover">
                            <thead><tr><th>Imię</th><th>Nazwisko</th><th>Akcja</th></tr></thead>
                            <tbody id="orderCustomerList"></tbody>
                        </table>
                        <div id="selectedCustomerDetails" class="alert alert-info mt-3" style="display: none;">
                            <strong>Wybrano klienta:</strong>
                            <p id="customerName"></p>
                            <p id="customerContact"></p>
                            <p id="customerAddress"></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Wybierz pająki</h4>
                        <table class="table table-sm table-hover">
                            <thead><tr><th>Typ</th><th>Gatunek</th><th>Ilość na stanie</th><th>Ilość do zamówienia</th><th>Akcja</th></tr></thead>
                            <tbody id="orderSpiderList"></tbody>
                        </table>
                        <hr>
                        <h5>Wybrane pająki:</h5>
                        <ul id="selectedSpidersList" class="list-group list-group-flush"></ul>
                        <hr>
                        <h5 id="orderTotalPrice">Całkowita cena: 0.00 zł</h5>
                    </div>
                </div>
                <button class="btn btn-success mt-3" onclick="createOrder()">Utwórz zamówienie</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Szczegóły zamówienia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = 'http://localhost:8080/api';
    const contentDiv = document.getElementById('content');
    let currentPage = {};
    const totalPages = {};

    const ordersTemplate = `
        <h2>Lista zamówień <button class="btn btn-success float-end" onclick="openNewOrderModal()">Dodaj nowe zamówienie</button></h2>
        <h4 class="mt-4">Nowe zamówienia</h4>
        <table class="table table-striped">
            <thead><tr><th>ID</th><th>Data</th><th>Klient</th><th>Status</th><th>Cena</th><th>Akcje</th></tr></thead>
            <tbody id="newOrdersTableBody"></tbody>
        </table>
        <h4 class="mt-4">Zamówienia w trakcie realizacji</h4>
        <table class="table table-striped">
            <thead><tr><th>ID</th><th>Data</th><th>Klient</th><th>Status</th><th>Cena</th><th>Akcje</th></tr></thead>
            <tbody id="inProgressOrdersTableBody"></tbody>
        </table>
        <h4 class="mt-4">Zamówienia anulowane</h4>
        <table class="table table-striped">
            <thead><tr><th>ID</th><th>Data</th><th>Klient</th><th>Status</th><th>Cena</th><th>Akcje</th></tr></thead>
            <tbody id="cancelledOrdersTableBody"></tbody>
        </table>
    `;

    const customersTemplate = `<h2>Lista klientów</h2><button class="btn btn-primary mb-3" onclick="openCustomerModal()">Dodaj nowego klienta</button><div class="input-group mb-3"><input type="text" id="searchLastName" class="form-control" placeholder="Wyszukaj po nazwisku..."><button class="btn btn-outline-secondary" type="button" onclick="searchCustomers()">Szukaj</button></div><table class="table table-striped"><thead><tr><th>Imię</th><th>Nazwisko</th><th>Telefon</th><th>Email</th><th>Akcje</th></tr></thead><tbody id="customersTableBody"></tbody></table><nav><ul class="pagination justify-content-center" id="customersPagination"></ul></nav>`;
    const spidersTemplate = `<h2>Lista pająków</h2><button class="btn btn-primary mb-3" onclick="openSpiderModal()">Dodaj nowego pająka</button><table class="table table-striped"><thead><tr><th>Typ</th><th>Gatunek</th><th>Ilość na stanie</th><th>Rozmiar</th><th>Cena</th><th>CITES</th><th>Akcje</th></tr></thead><tbody id="spidersTableBody"></tbody></table><nav><ul class="pagination justify-content-center" id="spidersPagination"></ul></nav>`;

    function showSection(section) {
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        const activeLink = document.querySelector(`[data-section="${section}"]`);
        if(activeLink) activeLink.classList.add('active');

        contentDiv.innerHTML = '';

        switch (section) {
            case 'customers': contentDiv.innerHTML = customersTemplate; loadCustomers(currentPage.customers || 0); break;
            case 'orders': contentDiv.innerHTML = ordersTemplate; loadOrders(); break;
            case 'spiders': contentDiv.innerHTML = spidersTemplate; loadSpiders(currentPage.spiders || 0); break;
            default:
                contentDiv.innerHTML = `<div id="welcome-section" class="text-center"><h1>Witaj w systemie WMS</h1><p class="lead">Zarządzaj klientami, zamówieniami i pająkami.</p><p><button class="btn btn-primary btn-lg m-2" onclick="showSection('customers')">Przejdź do klientów</button><button class="btn btn-secondary btn-lg m-2" onclick="showSection('orders')">Przejdź do zamówień</button><button class="btn btn-success btn-lg m-2" onclick="showSection('spiders')">Przejdź do pająków</button></p></div>`;
        }
    }

    document.querySelectorAll('[data-section]').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(e.target.dataset.section);
        });
    });

    // ################### ORDER CREATION LOGIC ###################
    let selectedCustomer = null;
    let selectedSpiders = new Map();

    function openNewOrderModal() {
        selectedCustomer = null;
        selectedSpiders.clear();
        document.getElementById('selectedCustomerDetails').style.display = 'none';
        updateOrderSummary();
        new bootstrap.Modal(document.getElementById('newOrderModal')).show();
        loadAllCustomersForOrder();
        loadAllSpidersForOrder();
    }

    async function loadAllCustomersForOrder() {
        const tableBody = document.getElementById('orderCustomerList');
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center">Ładowanie...</td></tr>';
        const data = await fetchCustomers(0, 1000);
        tableBody.innerHTML = '';
        data.content.forEach(c => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${c.firstName}</td><td>${c.lastName}</td><td><button class="btn btn-sm btn-primary" onclick="selectCustomerAndDisplayDetails('${c.id}')">Wybierz</button></td>`;
            tableBody.appendChild(row);
        });
    }

    async function selectCustomerAndDisplayDetails(id) {
        try {
            const response = await fetch(`${API_URL}/customers/${id}`);
            if (!response.ok) throw new Error('Customer not found');
            const customer = await response.json();
            selectedCustomer = customer;
            document.getElementById('selectedCustomerDetails').style.display = 'block';
            document.getElementById('customerName').innerHTML = `**${customer.firstName} ${customer.lastName}**`;
            document.getElementById('customerContact').innerHTML = `Tel: ${customer.telephone || 'Brak'}, Email: ${customer.email || 'Brak'}`;
            document.getElementById('customerAddress').innerHTML = `Adres: ${customer.address || 'Brak'}, Paczkomat: ${customer.parcelLocker || 'Brak'}`;
        } catch (error) {
            console.error('Błąd podczas ładowania klienta:', error);
            alert('Wystąpił błąd podczas ładowania danych klienta.');
        }
    }

    async function loadAllSpidersForOrder() {
        const tableBody = document.getElementById('orderSpiderList');
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Ładowanie...</td></tr>';
        const data = await fetchSpiders(0, 1000);
        tableBody.innerHTML = '';
        data.content.forEach(s => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${s.typeName}</td><td>${s.speciesName}</td><td>${s.quantity}</td>
                    <td><input type="number" min="1" max="${s.quantity}" value="1" id="quantity_${s.id}" class="form-control form-control-sm"></td>
                    <td><button class="btn btn-sm btn-success" onclick="selectSpider('${s.id}', '${s.typeName}', '${s.speciesName}', ${s.price}, ${s.quantity})">Dodaj</button></td>`;
            tableBody.appendChild(row);
        });
    }

    function selectSpider(id, typeName, speciesName, price, maxQuantity) {
        const quantityInput = document.getElementById(`quantity_${id}`);
        const quantity = parseInt(quantityInput.value, 10);

        if (quantity <= 0 || quantity > maxQuantity) {
            alert('Ilość jest nieprawidłowa lub przekracza stan magazynowy.');
            return;
        }

        const currentQuantity = selectedSpiders.has(id) ? selectedSpiders.get(id).quantity : 0;
        const newQuantity = currentQuantity + quantity;

        if (newQuantity > maxQuantity) {
            alert('Ilość przekracza stan magazynowy.');
            return;
        }

        selectedSpiders.set(id, { id, typeName, speciesName, price, quantity: newQuantity });
        updateOrderSummary();
    }

    function removeSpider(id) {
        selectedSpiders.delete(id);
        updateOrderSummary();
    }

    function updateOrderSummary() {
        const list = document.getElementById('selectedSpidersList');
        list.innerHTML = '';
        let totalPrice = 0;
        selectedSpiders.forEach((spider) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `${spider.typeName} ${spider.speciesName} (${spider.quantity} szt.) - ${(spider.price * spider.quantity).toFixed(2)} zł <button class="btn btn-danger btn-sm" onclick="removeSpider('${spider.id}')">Usuń</button>`;
            list.appendChild(li);
            totalPrice += spider.price * spider.quantity;
        });
        document.getElementById('orderTotalPrice').innerText = `Całkowita cena: ${totalPrice.toFixed(2)} zł`;
    }

    async function createOrder() {
        if (!selectedCustomer) { alert('Proszę wybrać klienta.'); return; }
        if (selectedSpiders.size === 0) { alert('Proszę dodać pająki do zamówienia.'); return; }

        const orderData = {
            customerId: selectedCustomer.id,
            orderedSpiders: Array.from(selectedSpiders.values()).map(s => ({
                spiderId: s.id,
                quantity: s.quantity
            }))
        };

        try {
            const response = await fetch(`${API_URL}/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                alert('Zamówienie zostało pomyślnie utworzone!');
                loadOrders();
                showSection('orders');
                bootstrap.Modal.getInstance(document.getElementById('newOrderModal')).hide();
            } else {
                const errorData = await response.json();
                alert(`Wystąpił błąd podczas tworzenia zamówienia: ${errorData.message || response.statusText}`);
            }
        } catch (error) {
            console.error('Błąd:', error);
            alert('Wystąpił błąd podczas tworzenia zamówienia.');
        }
    }

    // ################### POZOSTAŁA LOGIKA ###################
    async function fetchCustomers(page = 0, size = 10, sortBy = 'lastName') { const url = `${API_URL}/customers?page=${page}&size=${size}&sortBy=${sortBy}`; const response = await fetch(url); return response.ok ? await response.json() : { content: [], totalPages: 0, number: 0 }; }
    async function searchCustomers() { const lastName = document.getElementById('searchLastName').value; const tableBody = document.getElementById('customersTableBody'); tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Ładowanie...</td></tr>'; if (lastName.trim() === '') { loadCustomers(0); return; } try { const response = await fetch(`${API_URL}/customers/lastName/${lastName}`); if (response.status === 404) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nie znaleziono klientów o podanym nazwisku.</td></tr>'; } else { const customers = await response.json(); renderCustomersTable(customers); document.getElementById('customersPagination').innerHTML = ''; } } catch (error) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Wystąpił błąd podczas wyszukiwania.</td></tr>'; } }
    function loadCustomers(page = 0) { fetchCustomers(page).then(data => { currentPage.customers = data.number; totalPages.customers = data.totalPages; renderCustomersTable(data.content); createPagination('customers', data.totalPages, data.number, loadCustomers); }); }
    function renderCustomersTable(customers) { const tableBody = document.getElementById('customersTableBody'); tableBody.innerHTML = ''; if (customers.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Brak klientów do wyświetlenia.</td></tr>'; return; } customers.forEach(c => { const row = document.createElement('tr'); row.innerHTML = `<td>${c.firstName}</td><td>${c.lastName}</td><td>${c.telephone || ''}</td><td>${c.email || ''}</td><td><button class="btn btn-sm btn-primary" onclick="openCustomerModal('${c.id}')">Edytuj</button> <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${c.id}')">Usuń</button></td>`; tableBody.appendChild(row); }); }
    async function openCustomerModal(id) { const modal = new bootstrap.Modal(document.getElementById('customerModal')); const form = document.getElementById('customerForm'); form.reset(); form.onsubmit = (e) => saveCustomer(e); if (id) { try { const response = await fetch(`${API_URL}/customers/${id}`); if (!response.ok) throw new Error('Customer not found'); const customer = await response.json(); document.getElementById('customerId').value = customer.id; document.getElementById('firstName').value = customer.firstName; document.getElementById('lastName').value = customer.lastName; document.getElementById('telephone').value = customer.telephone; document.getElementById('email').value = customer.email; document.getElementById('address').value = customer.address; document.getElementById('parcelLocker').value = customer.parcelLocker; } catch (error) { console.error('Error fetching customer:', error); alert('Nie udało się załadować danych klienta.'); } } modal.show(); }
    async function saveCustomer(e) { e.preventDefault(); const id = document.getElementById('customerId').value; const customer = { id: id || null, firstName: document.getElementById('firstName').value, lastName: document.getElementById('lastName').value, telephone: document.getElementById('telephone').value, email: document.getElementById('email').value, address: document.getElementById('address').value, parcelLocker: document.getElementById('parcelLocker').value }; const method = id ? 'PUT' : 'POST'; try { const response = await fetch(`${API_URL}/customers`, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(customer) }); if (response.ok) { alert(`Klient został ${id ? 'zaktualizowany' : 'dodany'} pomyślnie!`); bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide(); loadCustomers(currentPage.customers); } else { throw new Error(`HTTP error! status: ${response.status}`); } } catch (error) { console.error('Error saving customer:', error); alert('Wystąpił błąd podczas zapisywania klienta.'); } }
    async function deleteCustomer(id) { if (!confirm('Czy na pewno chcesz usunąć tego klienta?')) return; try { const response = await fetch(`${API_URL}/customers/${id}`, { method: 'DELETE' }); if (response.ok) { alert('Klient usunięty pomyślnie!'); loadCustomers(currentPage.customers); } else if (response.status === 404) { alert('Klient nie istnieje.'); } else { throw new Error(`HTTP error! status: ${response.status}`); } } catch (error) { console.error('Error deleting customer:', error); alert('Wystąpił błąd podczas usuwania klienta.'); } }
    async function fetchOrders(page = 0, size = 10, sortBy = 'date') { const url = `${API_URL}/orders?page=${page}&size=${size}&sortBy=${sortBy}`; const response = await fetch(url); return response.ok ? await response.json() : { content: [] }; }
    async function loadOrders() {
        try {
            const data = await fetchOrders(0, 1000, 'date');
            const newOrdersBody = document.getElementById('newOrdersTableBody');
            const inProgressOrdersBody = document.getElementById('inProgressOrdersTableBody');
            const cancelledOrdersBody = document.getElementById('cancelledOrdersTableBody');
            newOrdersBody.innerHTML = '';
            inProgressOrdersBody.innerHTML = '';
            cancelledOrdersBody.innerHTML = '';

            data.content.forEach(order => {
                const row = document.createElement('tr');
                const customerName = order.customer ? `${order.customer.firstName} ${order.customer.lastName}` : 'N/A';
                const rowClass = order.status === 'CANCELLED' ? 'table-cancelled-order' : (order.status === 'PENDING' ? 'table-new-order' : '');
                row.className = rowClass;

                row.innerHTML = `
                    <td>${order.id.substring(0, 8)}</td>
                    <td>${order.date}</td>
                    <td>${customerName}</td>
                    <td>${order.status}</td>
                    <td>${order.price.toFixed(2)} zł</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showOrderDetails('${order.id}')">Szczegóły</button>
                        <button class="btn btn-sm btn-warning" onclick="openStatusModal('${order.id}', '${order.status}')">Status</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')">Usuń</button>
                    </td>
                `;

                if (order.status === 'PENDING') {
                    newOrdersBody.appendChild(row);
                } else if (order.status === 'IN_PROGRESS' || order.status === 'SHIPPED') {
                    inProgressOrdersBody.appendChild(row);
                } else if (order.status === 'CANCELLED') {
                    cancelledOrdersBody.appendChild(row);
                }
            });
        } catch (error) {
            console.error('Błąd podczas ładowania zamówień:', error);
            alert('Wystąpił błąd podczas ładowania zamówień.');
        }
    }

    async function showOrderDetails(orderId) {
        try {
            const response = await fetch(`${API_URL}/orders/${orderId}`);
            if (!response.ok) {
                throw new Error('Zamówienie nie znalezione');
            }
            const order = await response.json();
            const detailsContent = document.getElementById('orderDetailsContent');
            detailsContent.innerHTML = `
                <h5>Szczegóły zamówienia</h5>
                <p><strong>ID:</strong> ${order.id}</p>
                <p><strong>Data:</strong> ${order.date}</p>
                <p><strong>Klient:</strong> ${order.customer ? `${order.customer.firstName} ${order.customer.lastName}` : 'N/A'}</p>
                <p><strong>Status:</strong> ${order.status}</p>
                <p><strong>Cena:</strong> ${order.price.toFixed(2)} zł</p>
                <hr>
                <h6>Zamówione pająki:</h6>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Gatunek</th>
                            <th>Ilość</th>
                            <th>Cena jednostkowa</th>
                            <th>Suma</th>
                        </tr>
                    </thead>
                    <tbody id="orderedSpidersTableBody">
                    </tbody>
                </table>
            `;

            const spidersTableBody = document.getElementById('orderedSpidersTableBody');
            if (order.orderedSpiders && order.orderedSpiders.length > 0) {
                order.orderedSpiders.forEach(item => {
                    const row = document.createElement('tr');
                    const spider = item.spider;
                    const totalPrice = (spider.price * item.quantity).toFixed(2);
                    row.innerHTML = `
                        <td>${spider.speciesName}</td>
                        <td>${item.quantity}</td>
                        <td>${spider.price.toFixed(2)} zł</td>
                        <td>${totalPrice} zł</td>
                    `;
                    spidersTableBody.appendChild(row);
                });
            } else {
                spidersTableBody.innerHTML = `<tr><td colspan="4" class="text-center">Brak pająków w tym zamówieniu.</td></tr>`;
            }

            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();

        } catch (error) {
            console.error("Błąd podczas pobierania szczegółów zamówienia:", error);
            alert("Wystąpił błąd podczas pobierania szczegółów zamówienia.");
        }
    }

    async function deleteOrder(id) { if (!confirm('Czy na pewno chcesz usunąć to zamówienie?')) return; try { const response = await fetch(`${API_URL}/orders/${id}`, { method: 'DELETE' }); if (response.ok) { alert('Zamówienie usunięte pomyślnie!'); loadOrders(); } else { throw new Error('Błąd podczas usuwania zamówienia'); } } catch (error) { console.error('Błąd:', error); alert('Wystąpił błąd podczas usuwania zamówienia.'); } }
    async function openStatusModal(orderId, currentStatus) { const modal = new bootstrap.Modal(document.getElementById('orderStatusModal')); const form = document.getElementById('statusForm'); form.onsubmit = (e) => updateOrderStatus(e); document.getElementById('orderIdToUpdate').value = orderId; const select = document.getElementById('orderStatusSelect'); select.innerHTML = ''; ['PENDING', 'IN_PROGRESS', 'SHIPPED', 'COMPLETED', 'CANCELLED'].forEach(status => { const option = document.createElement('option'); option.value = status; option.text = status; if (status === currentStatus) option.selected = true; select.appendChild(option); }); modal.show(); }

    // ZMIENIONA FUNKCJA updateOrderStatus
    async function updateOrderStatus(e) {
        e.preventDefault();
        const orderId = document.getElementById('orderIdToUpdate').value;
        const newStatus = document.getElementById('orderStatusSelect').value;
        try {
            const response = await fetch(`${API_URL}/orders/${orderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            if (response.ok) {
                alert('Status zamówienia został zaktualizowany!');
                bootstrap.Modal.getInstance(document.getElementById('orderStatusModal')).hide();
                loadOrders();
            } else {
                const errorData = await response.json();
                alert(`Błąd podczas aktualizacji statusu: ${errorData.message || response.statusText}`);
            }
        } catch (error) {
            console.error('Błąd:', error);
            alert('Wystąpił błąd podczas aktualizacji statusu zamówienia.');
        }
    }

    async function fetchSpiders(page = 0, size = 10, sortBy = 'speciesName') { const url = `${API_URL}/spiders?page=${page}&size=${size}&sortBy=${sortBy}`; const response = await fetch(url); return response.ok ? await response.json() : { content: [], totalPages: 0, number: 0 }; }
    function loadSpiders(page = 0) { fetchSpiders(page).then(data => { currentPage.spiders = data.number; totalPages.spiders = data.totalPages; renderSpidersTable(data.content); createPagination('spiders', data.totalPages, data.number, loadSpiders); }); }
    function renderSpidersTable(spiders) { const tableBody = document.getElementById('spidersTableBody'); tableBody.innerHTML = ''; if (spiders.length === 0) { tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Brak pająków do wyświetlenia.</td></tr>'; return; } spiders.forEach(s => { const row = document.createElement('tr'); row.innerHTML = `<td>${s.typeName}</td><td>${s.speciesName}</td><td>${s.quantity}</td><td>${s.size}</td><td>${s.price.toFixed(2)} zł</td><td>${s.isCites ? 'Tak' : 'Nie'}</td><td><button class="btn btn-sm btn-primary" onclick="openSpiderModal('${s.id}')">Edytuj</button> <button class="btn btn-sm btn-danger" onclick="deleteSpider('${s.id}')">Usuń</button></td>`; tableBody.appendChild(row); }); }
    async function openSpiderModal(id) { const modal = new bootstrap.Modal(document.getElementById('spiderModal')); const form = document.getElementById('spiderForm'); form.reset(); form.onsubmit = (e) => saveSpider(e); if (id) { try { const response = await fetch(`${API_URL}/spiders/${id}`); if (!response.ok) throw new Error('Spider not found'); const spider = await response.json(); document.getElementById('spiderId').value = spider.id; document.getElementById('typeName').value = spider.typeName; document.getElementById('speciesName').value = spider.speciesName; document.getElementById('quantity').value = spider.quantity; document.getElementById('size').value = spider.size; document.getElementById('price').value = spider.price; document.getElementById('isCites').checked = spider.isCites; } catch (error) { console.error('Error fetching spider:', error); alert('Nie udało się załadować danych pająka.'); } } modal.show(); }
    async function saveSpider(e) { e.preventDefault(); const id = document.getElementById('spiderId').value; const spider = { id: id || null, typeName: document.getElementById('typeName').value, speciesName: document.getElementById('speciesName').value, quantity: document.getElementById('quantity').value, size: document.getElementById('size').value, price: document.getElementById('price').value, isCites: document.getElementById('isCites').checked }; const method = id ? 'PUT' : 'POST'; try { const response = await fetch(`${API_URL}/spiders`, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(spider) }); if (response.ok) { alert(`Pająk został ${id ? 'zaktualizowany' : 'dodany'} pomyślnie!`); bootstrap.Modal.getInstance(document.getElementById('spiderModal')).hide(); loadSpiders(currentPage.spiders); } else { throw new Error(`HTTP error! status: ${response.status}`); } } catch (error) { console.error('Error saving spider:', error); alert('Wystąpił błąd podczas zapisywania pająka.'); } }
    async function deleteSpider(id) { if (!confirm('Czy na pewno chcesz usunąć tego pająka?')) return; try { const response = await fetch(`${API_URL}/spiders/${id}`, { method: 'DELETE' }); if (response.ok) { alert('Pająk usunięty pomyślnie!'); loadSpiders(currentPage.spiders); } else if (response.status === 404) { alert('Pająk nie istnieje.'); } else { throw new Error(`HTTP error! status: ${response.status}`); } } catch (error) { console.error('Error deleting spider:', error); alert('Wystąpił błąd podczas usuwania pająka.'); } }
    function createPagination(section, totalPages, currentPage, loadFunction) { const pagination = document.getElementById(`${section}Pagination`); pagination.innerHTML = ''; for (let i = 0; i < totalPages; i++) { const li = document.createElement('li'); li.className = `page-item ${i === currentPage ? 'active' : ''}`; li.innerHTML = `<a class="page-link" href="#" onclick="loadFunction(${i})">${i + 1}</a>`; pagination.appendChild(li); } }

    // Initial load
    showSection('welcome-section');
</script>
</body>
</html>